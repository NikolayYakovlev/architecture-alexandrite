# Выбор и настройка мониторинга в системе


## 1. Мотивация
Компания «Александрит» в настоящий момент испытывает следующие трудности:
- рост жалоб клиентов о пропаже заказов,
- из-за аналогичных проблем в партнёрском API теряет контракты с партнерами,
- сталкивается с задержками релизов,
- нет прозрачности расчёта цены (2–30 мин),
- неэффективное получение данных на первой странице MES,
- единичные экземпляры приложений и баз данных.

Яндекс Метрика может дать представление только о фронте магазина, она не отражает потоки данных внутри системы через API и очереди. Без системного мониторинга:
- невозможно отличить задержку от потери сообщения,
- нет оговорённых метрик SLO для оценки состояния системы, приоритизации задач оптимизации и защиты бюджета,
- масштабирование и оптимизация будут производиться вслепую.

Цели мониторинга:
- сократить время, необходимое для обнаружения или идентификации проблемы (MTTI, Mean Time To Identify),
- стабилизировать lead time заказа (описанные в [Task1](<../Task1/Планирование анализ, идентификация проблем и поиск решений.md>) группы метрик lead time: _customer_, _internal_ и др.),
- вернуть доверие партнёров,
- обосновать поэтапное внедрение улучшений (очереди, кеш, масштабирование).


## 2. Выбор подходов
Все подходы используются комбинированно:
- Метод _RED_ (Requests Rate, Errors, Duration) _“фокусируется на показателях, которые связаны с запросами: на частоте запросов, их длительности и ошибках”_, может быстро показывать деградацию интерфейсов, поэтому используется для мониторинга API (Shop, CRM, MES, взаимодействие с партнёрами).
- Метод _Четыре золотых сигнала_ (Latency, Traffic, Errors, Saturation) _“позволяют комплексно оценивать производительность и надёжность систем”_, поэтому должны использоваться для критических эндпоинтов и очередей (вычисление стоимости заказа, события смены статуса).
- Метод _USE_ (Utilization, Saturation, Errors) “фокусирует внимание команды на …показателях, которые помогают эффективно выявлять и устранять проблемы с производительностью систем”, поэтому его эффективно использовать для оценки состояния инфраструктуры (CPU, память, диски, соединения БД, RabbitMQ, репликация, кэш) – даёт ранний сигнал об исчерпании ресурсов.


## 3. Метрики и ярлыки

| **Метрика**                              | **Имя**                           | **Системы**                                           |
|------------------------------------------|-----------------------------------|-------------------------------------------------------|
| Number of `dead-letter-exchange` letters | `dead_letter_messages_total`      | `RabbitMQ`                                            |
| Number of message `in flight`            | `queue_messages_unacknowledged`   | `RabbitMQ`                                            |
| Number of requests (RPS)                 | `http_requests_total`             | `shop API`, `CRM API`, `MES API`                      |
| Number of requests (RPS) per user        | `http_requests_total{user_id}`    | `shop API`, `CRM API`, `MES API`                      |
| CPU                                      | `cpu_utilization_percent`         | `shop API`, `CRM API`, `MES API`                      |
| Memory Utilisation                       | `memory_utilization_percent`      | `shop API`, `CRM API`, `MES API`, `shop db`, `MES db` |
| Number of connections                    | `db_active_connections`           | `shop db`, `MES db`                                   |
| Response time (latency)                  | `http_request_duration_seconds`   | `shop API`, `CRM API`, `MES API`                      |
| Size                                     | `db_storage_bytes`                | `S3 storage`, `shop db`, `MES db`                     |
| Number of `HTTP 200`                     | `http_status_total{status="200"}` | `shop API`, `CRM API`, `MES API`                      |
| Number of `HTTP 500`                     | `http_status_total{status="500"}` | `shop API`, `CRM API`, `MES API`                      |
| Number of simultaneous sessions          | `active_sessions`                 | `shop API`, `CRM API`, `MES API`                      |
| Kb transferred (received)                | `http_rx_bytes_total`             | `shop API`, `CRM API`, `MES API`                      |
| Kb provided (sent)                       | `http_tx_bytes_total`             | `shop API`,  `CRM API`,  `MES API`                    |

_Таблица предложенных метрик_

### 3.1 RabbitMQ (основные)
- `dead_letter_messages_total` — число сообщений в DLQ; поток ошибок. Labels: queue, environment.
- `queue_messages_unacknowledged` — сообщения «в полёте» (уже выданы consumer’у, но ещё не ack'уты - метрика “подвисания” сообщения). Labels: queue.

- `queue_messages_ready` (в дополнении к `in flight` для полноты) — количество сообщений, ожидающих выдачи consumer’у (глубина очереди ready – ранний признак задержек). Labels: queue, environment.
- `messages_published_total` — количество сообщений, отправленных в очередь. Labels: queue, environment.
- `cache_hit_ratio_percent` — эффективность кеша. Labels: cache_name.
- `queue_consumers` — активные consumer’ы; мониторинг параллелизма.
- `order_queue_backlog_ratio` (ready/consumers) — насыщенность; алерт при >5. Labels: queue.
- `publish_confirm_lag_seconds` — задержка подтверждений.

### 3.2 API - _RED_ (Shop / CRM / MES)
- `http_requests_total` — общий RPS. Labels: service, endpoint_group, method.
- `http_requests_total{user_id}` — RPS per user. Labels: service, user_id.
- `http_request_duration_seconds` (гистограмма) — время ответа (Response time (latency)). Labels: service, endpoint_group, method.
- `http_status_total{status="200"}` — успешные ответы (Number of `HTTP 200`). Labels: service, endpoint_group.
- `http_status_total{status="500"}` — ответы с 500-ошибкой (Number of `HTTP 500`). Labels: service, endpoint_group.
- `active_sessions` — одновременные сессии (Number of simultaneous sessions). Labels: service.
- `http_rx_bytes_total` — входящий трафик (Kb transferred (received)). Labels: service.
- `http_tx_bytes_total` — исходящий трафик (Kb provided (sent)). Labels: service.

**Дополнительные метрики**
- `http_status_count{status_code}` — распределение SUCCESS vs ERROR. Labels: service, endpoint_group.
- `http_errors_total` — ошибки 5xx/4xx. Labels: service, status_code, endpoint_group.
- `api_partner_rps{partner_id}` — нагрузка по партнёрам для rate limiting. Labels: partner_id.
- `dashboard_first_page_latency` — выдача списка «новых заказов» в дашборде MES (p95).

### 3.3 Ресурсы приложений - _USE_
- `cpu_utilization_percent` — загрузка CPU (CPU) (алерты на загрузку >70%). Labels: service, instance.
- `memory_utilization_percent` — использование памяти (Memory Utilisation, алерт на загрузку >85%). Labels: service, instance.

- `disk_iops_used` / `disk_latency_ms` — “насыщенность” дисков (Saturation). Labels: instance.

### 3.4 Базы данных / S3
- `db_active_connections` — активные соединения, насыщение пулов (Number of connections). Labels: db_role, service.
- `db_storage_bytes` — размер инстанса (Size shop db / MES db). Labels: db_role.

- `s3_bucket_bytes` — размер хранилища 3D моделей S3 (Size of S3 storage). Labels: bucket.
- `db_replication_lag_seconds` — актуальность read replica. Labels: replica_id.

### 3.5 Бизнес метрики
- `order_lead_time_seconds` (Histogram) — `SUBMITTED` → `DELIVERED` (клиентский опыт, _Customer lead time_). Labels: product_type, environment.
- `order_cycle_time_seconds` — `SUBMITTED` → `MANUFACTURING_COMPLETED` (фаза производства). Labels: product_type.
- `price_calc_duration_seconds` — длительность расчёта; SLA. Labels: complexity_class (polygon_bucket — категория сложности расчёта, например, по числу вершин).
- `manufacturing_stage_duration_seconds` — `MANUFACTURING_STARTED` → `MANUFACTURING_COMPLETED` (время производства, _Manufacturing lead time_). Labels: operator_id (можно агрегировать), product_type.
- `packaging_duration_seconds` — `PACKAGING_STARTED` → `PACKAGING_COMPLETED`.

### 3.6 Ярлыки
- environment (dev|release|prod)
- service (shop|crm|mes)
- endpoint_group (`/orders`, `/pricing` и т.д.)
- queue
- user_id
- partner_id
- operator_id
    - Агрегирование позволит оценить среднюю, p95 длительность производства каждым оператором, выявить узкие места и сравнить их производительность.
- product_type / complexity_class
- instance
- db_role (primary|replica)
- bucket


## 4. План действий

1. Развернуть Prometheus, Grafana и Alertmanager.
2. Подключить экспортёры в приложения, базы данных и кеш.
3. Добавить OpenTelemetry SDK в Shop/CRM/MES.
4. Стандартизовать формат метрик и ярлыков.
5. Реализовать отслеживание метрик
    - длительности расчёта цены (`price_calc_duration_seconds`): начало/конец (`PRICE_CALCULATION_STARTED`/`PRICE_CALCULATED`),
    - времени между сменой статусов заказа (`stage_duration`).
6. Создать дашборды:
   - Заказы (lead/cycle time, версия, backlog, DLQ).
   - Расчёт цены (_Четыре золотых сигнала_: длительность, p95, backlog ratio).
   - API (_RED_: RPS, latency, errors).
   - Ресурсы (_USE_: CPU, память, DB connections).
7. Определить SLO (см. ниже):
   - p95 `dashboard_first_page_latency` ≤ 300ms.
   - p95 `price_calc_duration_seconds` ≤ 600s.
   - `order_queue_backlog_ratio` < 5.
   - `dead_letter_ratio` ≈ 0 (PromQL: increase(dead_letter_messages_total[5m]) / (increase(messages_published_total[5m]) + 1))
8. Настроить алерты по таблице порогов, интегрировать их с мессенджерами.
9. Внедрить autoscale по метрикам CPU / latency и др. (например, глубина очереди).
10. Постепенное расширение покрытия с ключевых внутренних систем на партнёрское API, масштабируемые системы


## 5. Показатели насыщенности (saturation thresholds) и реакции

| Показатель                         | Порог          | Причина                                   | Авто/Действие                                                                             |
|------------------------------------|----------------|-------------------------------------------|-------------------------------------------------------------------------------------------|
| `order_queue_backlog_ratio`        | >5 5мин        | Недостаток consumers / блокирующие calc   | Уведомление, масштабирование consumers, проверка длительности расчёта                     |
| `price_calc_duration_seconds` p95  | > SLA (10 мин) | Узкое место CPU / алгоритм                | Уведомление, создание тикета для исправления/оптимизации/кеша расчёта                     |
| `dead_letter_messages_total` рост  | > N/5мин       | Формат / временные ошибки                 | Анализ причины, пересмотр политики ретраев, backpressure для внутренних и партнёрских API |
| `db_active_connections` / `max`    | >80%           | Риски новых подключений                   | Масштабирование пула / добавление реплики, проведение аудит долгих запросов               |
| `cache_hit_ratio_percent`          | <80%           | Низкая эффективность кеша                 | Проверить ключи/TTL, добавить прогрев                                                     |
| `cpu_utilization_percent`          | >75% 5мин      | Насыщение                                 | Autoscale                                                                                 |
| `memory_utilization_percent`       | >85%           | Риск Out Of Memory                        | Autoscale / оптимизация heap                                                              |
| `db_replication_lag_seconds`       | >2s            | Задержка чтений                           | Перенаправить критичные SELECT на primary                                                 |
| `publish_confirm_lag_seconds`      | >1s            | Брокер перегружен                         | Ограничить входящий Rate, масштабировать брокер                                           |
| `dashboard_first_page_latency`     | ≥300ms 5мин    | Насыщение                                 | Autoscale                                                                                 |
| `dead_letter_ratio` *              | >0.5% 5мин     | Насыщение                                 | Autoscale / оптимизация rate limiting                                                     |

\* - `(increase(dead_letter_messages_total[5m]) / (increase(messages_published_total[5m]) + 1))`

Реакции:
- Автоматическая: HPA (Kubernetes) / добавление consumers для очередей / включение rate limiting.
- Ручная: тикет оптимизации алгоритма расчёта, анализ сообщений DLQ.
- Эскалация: уведомление devops в мессенджер, при повторе — инцидент.